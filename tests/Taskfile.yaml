version: '3'

tasks:
    test:
        desc: Run all packaging tests in parallel
        platforms: [linux]
        parallel: true
        deps:
        - test-self
        - test-editable
        - test-external
        - test-workspace
        - test-group
        - test-extra

    test-self:
        desc: "Run tests for self-packaging installation"
        platforms: [linux]
        dir: tests
        vars:
            FOLDER: '{{.TASK | splitList ":" | last}}'
        cmds:
            - rm -rf {{.FOLDER}}
            - uv init {{.FOLDER}} --package --no-workspace
            - uv --directory {{.FOLDER}} run --with ../.. uv-pack --skip python
            - BASE_PY="$(uv --directory {{.FOLDER}} python find)" sh {{.FOLDER}}/pack/unpack.sh
            - '{{.FOLDER}}/pack/.venv/bin/python -c "import test_self;"'

    test-editable:
        desc: "Run for a single editable installation"
        platforms: [linux]
        dir: tests
        vars:
            FOLDER: '{{.TASK | splitList ":" | last}}'
        cmds:
            - rm -rf {{.FOLDER}}
            - uv init {{.FOLDER}} --bare --no-workspace
            - uv --directory {{.FOLDER}} init a --package --no-workspace
            - uv --directory {{.FOLDER}} add --editable ./a --no-workspace
            - uv --directory {{.FOLDER}} run --with ../.. uv-pack --skip python
            - BASE_PY="$(uv --directory {{.FOLDER}} python find)" sh {{.FOLDER}}/pack/unpack.sh
            - '{{.FOLDER}}/pack/.venv/bin/python -c "import a;"'

    test-external:
        desc: "Run tests for a single external installation"
        platforms: [linux]
        dir: tests
        vars:
            FOLDER: '{{.TASK | splitList ":" | last}}'
        cmds:
            - rm -rf {{.FOLDER}}
            - uv init {{.FOLDER}} --bare --no-workspace
            - uv --directory {{.FOLDER}} add parse
            - uv --directory {{.FOLDER}} run --with ../.. uv-pack --skip python
            - BASE_PY="$(uv --directory {{.FOLDER}} python find)" sh {{.FOLDER}}/pack/unpack.sh
            - '{{.FOLDER}}/pack/.venv/bin/python -c "import parse;"'

    test-workspace:
        desc: "Run tests for a workspace package"
        platforms: [linux]
        dir: tests
        vars:
            FOLDER: '{{.TASK | splitList ":" | last}}'
        cmds:
            - rm -rf {{.FOLDER}}
            - uv init {{.FOLDER}} --bare --no-workspace
            - uv --directory {{.FOLDER}} init a --package
            - uv --directory {{.FOLDER}} init b --package
            - uv --directory {{.FOLDER}} init c --package
            - uv --directory {{.FOLDER}} add --package a b
            - uv --directory {{.FOLDER}} add --package b c
            - uv --directory {{.FOLDER}} run --with ../.. uv-pack --skip python --uv-export "--package a"
            - BASE_PY="$(uv --directory {{.FOLDER}} python find)" sh {{.FOLDER}}/pack/unpack.sh
            - '{{.FOLDER}}/pack/.venv/bin/python -c "import c;"'

    test-group:
        desc: "Run tests for groups being included during export"
        platforms: [linux]
        dir: tests
        vars:
            FOLDER: '{{.TASK | splitList ":" | last}}'
        cmds:
            - rm -rf {{.FOLDER}}
            - uv init {{.FOLDER}} --bare --no-workspace
            - uv --directory {{.FOLDER}} init a --package --no-workspace
            - uv --directory {{.FOLDER}} add ./a --group extra --no-workspace
            - uv --directory {{.FOLDER}} add parse --group extra
            - uv --directory {{.FOLDER}} run --with ../.. uv-pack --skip python --uv-export "--group extra"
            - BASE_PY="$(uv --directory {{.FOLDER}} python find)" sh {{.FOLDER}}/pack/unpack.sh
            - '{{.FOLDER}}/pack/.venv/bin/python -c "import parse; import a;"'

    test-extra:
        desc: "Run tests for extras being included during export"
        platforms: [linux]
        dir: tests
        vars:
            FOLDER: '{{.TASK | splitList ":" | last}}'
        cmds:
            - rm -rf {{.FOLDER}}
            - uv init {{.FOLDER}} --bare --no-workspace
            - uv --directory {{.FOLDER}} init a --package --no-workspace
            - uv --directory {{.FOLDER}} add ./a --optional extra --no-workspace
            - uv --directory {{.FOLDER}} add parse --optional extra
            - uv --directory {{.FOLDER}} run --with ../.. uv-pack --skip python --uv-export "--extra extra"
            - BASE_PY="$(uv --directory {{.FOLDER}} python find)" sh {{.FOLDER}}/pack/unpack.sh
            - '{{.FOLDER}}/pack/.venv/bin/python -c "import parse; import a;"'
